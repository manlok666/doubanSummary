<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <!-- æ–°å¢ï¼šå“åº”å¼ viewport ä¸ fonts é¢„è¿æ¥ï¼Œæå‡å­—ä½“æ¸²æŸ“ä½“éªŒ -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <title>è±†ç“£åª’ä½“åŒæ­¥</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body data-theme="light" data-page="index">
<div class="app">
    <div class="panel top-panel">
        <div class="top-bar">
            <!-- æ–°å¢ï¼šæœç´¢æ¡†ï¼ˆç¡®ä¿ id ä¸è„šæœ¬ä¸€è‡´ï¼‰ -->
            <div class="search-box">
                <input id="search-input" type="text" />
                <span class="search-icon">ğŸ”</span>
                <div class="suggestions" id="suggestions" style="display:none;"></div>
            </div>
            <a href="/analysis.html" class="pill-link">ğŸ“Š æ•°æ®åˆ†æ</a>
            <a id="refresh-data-btn" class="pill-link" title="åˆ·æ–°æ•°æ®">ğŸ”„ åˆ·æ–°</a>
            <div class="controls">
                <div class="filters">
                    <div class="filter-group">
                        <div class="filter-label">è§‚å½±å¹´ä»½</div>
                        <div class="chip-list" id="filter-watch-years"></div>
                    </div>
                    <!-- ä¸Šæ˜ å¹´ä»½ç­›é€‰å·²ç§»é™¤ -->
                    <div class="filter-group">
                        <div class="filter-label">è¯„åˆ†</div>
                        <div class="chip-list" id="filter-ratings"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="section-head">
            <span>å½“å‰ç±»åˆ«ï¼š<b id="current-cat">ç”µå½±</b></span>
        </div>
        <div id="content"></div>
        <div class="pagination">
            <button id="prev-page">â€¹ ä¸Šä¸€é¡µ</button>
            <div class="info-card" id="page-info-bottom">ç¬¬ 1 / 1 é¡µ</div>
            <div class="page-jump">
                <label for="page-input">è·³è½¬</label>
                <input id="page-input" class="page-input" type="number" min="1" step="1" />
            </div>
            <button id="next-page">ä¸‹ä¸€é¡µ â€º</button>
        </div>
    </div>
</div>

<!-- æ–°å¢ï¼šé¡µé¢å³ä¾§å›ºå®šä¾§æ ï¼ˆå¡ç‰‡ç½©ä½ç«–å‘å›¾æ ‡æŒ‰é’®ï¼‰ -->
<aside class="right-sidebar" aria-hidden="false">
    <div class="sidebar-card">
        <div class="nav-tabs" role="tablist" aria-orientation="vertical">
            <button data-cat="movies" class="active" title="ç”µå½±" aria-label="ç”µå½±">
                <span class="emoji" aria-hidden="true">ğŸ¬</span>
            </button>
            <button data-cat="books" title="ä¹¦ç±" aria-label="ä¹¦ç±">
                <span class="emoji" aria-hidden="true">ğŸ“š</span>
            </button>
            <button data-cat="games" title="æ¸¸æˆ" aria-label="æ¸¸æˆ">
                <span class="emoji" aria-hidden="true">ğŸ®</span>
            </button>
            <button data-cat="music" title="éŸ³ä¹" aria-label="éŸ³ä¹">
                <span class="emoji" aria-hidden="true">ğŸµ</span>
            </button>
        </div>
    </div>
</aside>

<!-- æ–°å¢ï¼šè®¾ç½®ç‹¬ç«‹ä¾§æ ï¼Œä½äºä¸»ä¾§æ ä¸‹æ–¹çº¦ 130px -->


<div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
        <div class="modal-head">
            <div class="modal-icon">âš™ï¸</div>
            <div class="modal-title">
                <h3>ç•Œé¢è®¾ç½®</h3>
                <p>è°ƒæ•´æ·±æµ…é…è‰²ä¸æ˜¾ç¤ºåå¥½</p>
            </div>
            <button id="close-modal" class="modal-close" aria-label="å…³é—­è®¾ç½®">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="modal-row">
                <div>
                    <div class="row-title">æµ…è‰²æ¨¡å¼</div>
                    <div class="row-sub">åœ¨æµ…è‰²/æ·±è‰²ä¹‹é—´å¿«é€Ÿåˆ‡æ¢</div>
                </div>
                <button id="theme-switch" class="switch on" role="switch" aria-checked="true" tabindex="0"></button>
            </div>
        </div>
    </div>
</div>

<div class="detail-backdrop" id="detail-backdrop">
    <div class="detail-modal">
        <div class="detail-modal-head">
            <div class="detail-title-wrap">
                <h3 id="detail-title"></h3>
                <div id="detail-meta" class="meta detail-meta"></div>
            </div>
            <!-- æ–°å¢ï¼šåœ¨è±†ç“£è·³è½¬æŒ‰é’® -->
            <button id="detail-open-link" class="detail-open-link" aria-label="åœ¨è±†ç“£æ‰“å¼€">è±†ç“£ğŸ”—</button>
            <button id="detail-close" class="detail-close" aria-label="å…³é—­è¯¦æƒ…">âœ•</button>
        </div>
        <div class="detail-body">
            <img id="detail-cover" class="detail-cover" alt="cover" src="" />
            <div class="detail-info">
                <div class="detail-section glass-chip">
                    <span class="section-label">æ—¶é—´</span>
                    <div id="detail-time" class="time"></div>
                </div>
                <div class="detail-section glass-chip">
                    <span class="section-label">è¯„è®º</span>
                    <div id="detail-comments" class="detail-comments"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="dim-overlay" id="dim-overlay"></div>

<script>
    const searchInput = document.getElementById('search-input');
    const suggestionsBox = document.getElementById('suggestions');
    const contentEl = document.getElementById('content');
    const currentCatLabel = document.getElementById('current-cat');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const closeModalBtn = document.getElementById('close-modal');
    const themeSwitch = document.getElementById('theme-switch');
    const detailBackdrop = document.getElementById('detail-backdrop');
    const detailClose = document.getElementById('detail-close');
    const detailTitle = document.getElementById('detail-title');
    const detailMeta = document.getElementById('detail-meta');
    const detailTime = document.getElementById('detail-time');
    const detailComments = document.getElementById('detail-comments');
    const detailCover = document.getElementById('detail-cover');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const pageInfoBottom = document.getElementById('page-info-bottom');
    const pageInput = document.getElementById('page-input');
    const dimOverlay = document.getElementById('dim-overlay');
    const watchYearWrap = document.getElementById('filter-watch-years');
    // releaseYearWrap å·²åˆ é™¤
    const ratingWrap = document.getElementById('filter-ratings');
    const filtersPanel = document.getElementById('filters-panel');

    initializeTheme();

    const PAGE_SIZE = 24;
    const BATCH_SIZE = 24;
    const state = {
        movies: { items: [], page: 1 },
        books:  { items: [], page: 1 },
        games:  { items: [], page: 1 },
        music:  { items: [], page: 1 },
    };
    let activeCat = 'movies';
    let pendingFocusId = null;
    const globalIndex = { movies: [], books: [], games: [], music: [] };

    const ENDPOINTS = {
        movies: '/data/movies.json',
        books:  '/data/books.json',
        games:  '/data/games.json',
        music:  '/data/music.json',
    };

    document.querySelectorAll('.nav-tabs button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeCat = btn.dataset.cat;
            state[activeCat].page = 1;
            currentCatLabel.textContent = {movies:'ç”µå½±',books:'ä¹¦ç±',games:'æ¸¸æˆ',music:'éŸ³ä¹'}[activeCat];
            populateFilterOptions();
            render();
        });
    });
    
    closeModalBtn.onclick = () => { modalBackdrop.style.display = 'none'; };
    themeSwitch.onclick = () => {
        const nextTheme = themeSwitch.classList.contains('on') ? 'dark' : 'light';
        applyTheme(nextTheme);
    };
    themeSwitch.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            themeSwitch.click();
        }
    });

    prevBtn.onclick = () => changePage(-1);
    nextBtn.onclick = () => changePage(1);

    pageInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            const target = Number(pageInput.value);
            // ä½¿ç”¨è¿‡æ»¤åçš„æ¡ç›®æ•°è®¡ç®—æ€»é¡µæ•°
            const filteredCount = applyIndexFilters(state[activeCat].items).length;
            const totalPages = Math.max(1, Math.ceil(filteredCount / PAGE_SIZE));
            const page = Math.min(totalPages, Math.max(1, isFinite(target) ? target : 1));
            state[activeCat].page = page;
            render();
        }
    });

    function changePage(delta) {
        // ä½¿ç”¨è¿‡æ»¤åçš„æ¡ç›®æ•°è®¡ç®—æ€»é¡µæ•°
        const catState = state[activeCat];
        const filteredCount = applyIndexFilters(catState.items).length;
        const total = Math.max(1, Math.ceil(filteredCount / PAGE_SIZE));
        catState.page = Math.min(total, Math.max(1, catState.page + delta));
        render();
    }

    function starify(rating) {
        if (!rating) return '';
        const n = Math.max(1, Math.min(5, Number(rating)));
        return 'ğŸŒŸ'.repeat(n);
    }

    function openDetail(item) {
        detailTitle.textContent = item.title || item.name || 'æœªå‘½å';
        const year = item.year || '';
        const stars = starify(item.rating);
        detailMeta.textContent = [year, stars].filter(Boolean).join(' Â· ');
        detailTime.textContent = item.updated_at || item.date || '';
        const comments = item.comments || [];
        detailComments.innerHTML = comments.length
            ? comments.map(c => `<div class="comment-item">${c}</div>`).join('')
            : '<div class="comment-item">æš‚æ— è¯„è®º</div>';
        const cover = item.cover || item.image || '';
        if (cover) {
            detailCover.src = cover;
            detailCover.setAttribute('referrerpolicy', 'no-referrer');
            detailCover.onerror = () => { detailCover.src = `data:image/svg+xml,${encodeURIComponent(placeholderSvg(item.title))}`; };
        } else {
            detailCover.src = `data:image/svg+xml,${encodeURIComponent(placeholderSvg(item.title))}`;
        }
        // ç»‘å®šè¯¦æƒ…å¼¹çª—çš„è±†ç“£è·³è½¬æŒ‰é’®
        const detailOpenBtn = document.getElementById('detail-open-link');
        if (detailOpenBtn) {
            detailOpenBtn.dataset.link = item.link || '';
            detailOpenBtn.onclick = (e) => {
                e.stopPropagation();
                const l = detailOpenBtn.dataset.link;
                if (l) window.open(l, '_blank', 'noopener');
            };
            // éšè—/æ˜¾ç¤ºæŒ‰é’®æ ¹æ® link æ˜¯å¦å­˜åœ¨
            detailOpenBtn.style.display = item.link ? 'inline-flex' : 'none';
        }
        detailBackdrop.style.display = 'flex';
    }
    detailBackdrop.addEventListener('click', e => { if (e.target === detailBackdrop) detailBackdrop.style.display = 'none'; });
    detailClose.onclick = () => detailBackdrop.style.display = 'none';

    async function loadAll() {
        await Promise.all(Object.keys(ENDPOINTS).map(loadCategory));
        render();
    }

    async function loadCategory(cat) {
        try {
            const res = await fetch(ENDPOINTS[cat], { cache: 'no-cache' });
            if (!res.ok) throw new Error('è·å–å¤±è´¥');
            const data = await res.json();
            state[cat].items = data.items || [];
            // æŒ‰ updated_atï¼ˆå›é€€åˆ° dateï¼‰åšå€’åºæ’åºï¼Œç¡®ä¿æœ€æ–°è§‚å½±æ—¶é—´åœ¨å‰
            state[cat].items.sort((a, b) => {
                const ta = Date.parse(a.updated_at || a.date || '') || 0;
                const tb = Date.parse(b.updated_at || b.date || '') || 0;
                return tb - ta; // å€’åº
            });
            state[cat].page = 1;
            buildGlobalIndex(cat);
            if (cat === activeCat) populateFilterOptions();
        } catch (e) {
            console.error(`${cat} åŠ è½½å¤±è´¥ï¼š${e.message}`);
        }
    }

    function buildGlobalIndex(cat) {
        globalIndex[cat] = (state[cat].items || []).map((item, idx) => ({
            titleLower: (item.title || item.name || '').toLowerCase(),
            title: item.title || item.name || 'æœªå‘½å',
            idx,
            cover: item.cover || item.image || '',
        }));
    }

    function render() {
        const { items } = state[activeCat];
        // applyIndexFilters ç°åœ¨è¿”å› entries: [{item, idx}, ...]
        const filteredEntries = applyIndexFilters(items);
        const totalPages = Math.max(1, Math.ceil(filteredEntries.length / PAGE_SIZE));
        const page = Math.min(totalPages, Math.max(1, state[activeCat].page));
        state[activeCat].page = page;
        const start = (page - 1) * PAGE_SIZE;
        const pageEntries = filteredEntries.slice(start, start + PAGE_SIZE);

        contentEl.innerHTML = '';
        // ä¼ å…¥ entries åˆ—è¡¨ï¼ˆæ¯é¡¹ä¸º {item, idx}ï¼‰
        renderPageBatched(pageEntries);

        pageInfoBottom.textContent = `ç¬¬ ${page} / ${totalPages} é¡µ`;
        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page >= totalPages;
    }

    function renderPageBatched(entries) {
        let i = 0;
        function step() {
            const batchFrag = document.createDocumentFragment();
            for (let c = 0; c < BATCH_SIZE && i < entries.length; c++, i++) {
                // entries[i] æ˜¯ { item, idx }
                const entry = entries[i];
                batchFrag.appendChild(makeCard(entry.item, entry.idx));
            }
            contentEl.appendChild(batchFrag);
            if (i < entries.length) {
                requestAnimationFrame(step);
            } else {
                attachCardClicks();
                setupLazyImages();
                if (pendingFocusId) {
                    focusCard(pendingFocusId);
                    pendingFocusId = null;
                }
            }
        }
        step();
    }

    function makeCard(item, idx) {
        const cat = activeCat;
        const title = item.title || item.name || 'æœªå‘½å';
        const desc = item.desc || item.summary || '';
        const tags = item.tags && item.tags.length ? `#${item.tags.join(' #')}` : '';
        const stars = starify(item.rating);
        const year = item.year || '';
        const time = item.updated_at || item.date || '';
        const commentBrief = (item.comments && item.comments.length) ? item.comments[0] : '';
        const id = `${cat}-${idx}`;

        const linkId = extractIdFromLink(item.link);
        const imageKey = linkId || slugify(title || `pic-${id}`);
        const cover = item.cover || item.image || '';

        const card = document.createElement('div');
        card.className = 'card';
        card.id = id;
        card.dataset.cat = cat;
        // dataset.idx ä¿å­˜åŸå§‹æ•°ç»„ç´¢å¼•ï¼Œä¾›ç‚¹å‡»è¯»å–çœŸå®å¯¹è±¡
        card.dataset.idx = idx;

        const img = document.createElement('img');
        img.setAttribute('loading', 'lazy');
        img.dataset.cover = cover;
        img.dataset.key = imageKey;
        img.alt = title;
        img.src = `data:image/svg+xml,${encodeURIComponent(placeholderSvg(title))}`;

        const info = document.createElement('div');
        info.innerHTML = `
            <div class="title-txt">${title}</div>
            <div class="meta">${[year, stars].filter(Boolean).join(' Â· ')}</div>
            <div class="time">${time}</div>
            <div class="comment-brief">${commentBrief ? `ğŸ’¬ ${commentBrief}` : ''}</div>
        `;

        card.appendChild(img);
        card.appendChild(info);
        return card;
    }

    function attachCardClicks() {
        contentEl.querySelectorAll('.card').forEach(card => {
            card.onclick = () => {
                const cat = card.dataset.cat;
                const idx = Number(card.dataset.idx);
                const item = state[cat].items[idx];
                if (!item) return;
                openDetail(item);
            };
        });
    }

    const PIC_ROOT = '/data/pic';
    const slugHeadCache = new Set();
    let imgObserver = null;

    function setupLazyImages() {
        if (imgObserver) imgObserver.disconnect();
        imgObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    hydrateOneImage(entry.target);
                    imgObserver.unobserve(entry.target);
                }
            });
        }, { rootMargin: '200px 0px', threshold: 0.1 });

        contentEl.querySelectorAll('img[data-cover][data-key]').forEach(img => {
            imgObserver.observe(img);
        });
    }

    async function hydrateOneImage(img) {
        if (img.dataset.hydrated) return;
        const cover = img.dataset.cover;
        const key = img.dataset.key || 'pic';
        const localPath = `${PIC_ROOT}/${key}.jpg`;

        if (slugHeadCache.has(localPath) || await headLocal(localPath)) {
            slugHeadCache.add(localPath);
            img.src = localPath;
            img.dataset.hydrated = '1';
            return;
        }
        if (!cover) return;
        const ok = await cacheRemote(key, cover);
        if (ok) {
            slugHeadCache.add(localPath);
            img.src = localPath;
        } else {
            img.src = cover;
            img.onerror = () => { img.src = `data:image/svg+xml,${encodeURIComponent(placeholderSvg(cover))}`; };
        }
        img.dataset.hydrated = '1';
    }

    async function headLocal(path) { try { const res = await fetch(path, { method:'HEAD', cache:'no-cache' }); return res.ok; } catch { return false; } }
    async function cacheRemote(picId, coverUrl) {
        try {
            const res = await fetch('/api/cache-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pic_id: picId, url: coverUrl }) });
            return res.ok;
        } catch { return false; }
    }
    function slugify(str) { return (str || 'pic').toLowerCase().replace(/[^\w\u4e00-\u9fa5]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'').slice(0,60) || 'pic'; }

    function extractIdFromLink(link) {
        if (!link) return null;
        const m = link.match(/\d+/);
        return m ? m[0] : null;
    }

    function placeholderSvg(text) {
        const safe = (text || '?').slice(0, 6);
        return `<svg xmlns='http://www.w3.org/2000/svg' width='160' height='220'>
            <rect width='100%' height='100%' fill='%23dfe4f5'/>
            <text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' fill='%235d6a86' font-size='18' font-family='Inter, sans-serif'>${safe}</text>
        </svg>`;
    }

    let searchDebounce = null;
    function fuzzySuggest(keyword) {
        const k = keyword.trim().toLowerCase();
        if (!k) return [];
        return globalIndex[activeCat].filter(x => x.titleLower.includes(k)).slice(0, 8);
    }

    function showSuggestions(list) {
        if (!list.length) { suggestionsBox.style.display = 'none'; suggestionsBox.innerHTML = ''; return; }
        suggestionsBox.innerHTML = list.map(x => `
            <div class="suggestion-item" data-idx="${x.idx}">
                <img src="${x.cover || `data:image/svg+xml,${encodeURIComponent(placeholderSvg(x.title))}`}" alt="">
                <div class="title">${x.title}</div>
            </div>
        `).join('');
        suggestionsBox.style.display = 'block';
    }
    function hideSuggestions() { suggestionsBox.style.display = 'none'; suggestionsBox.innerHTML = ''; }

    suggestionsBox.addEventListener('click', e => {
        const target = e.target.closest('.suggestion-item');
        if (!target) return;
        const idx = Number(target.dataset.idx);
        jumpToIdx(idx);
        hideSuggestions();
    });
    searchInput.addEventListener('input', () => {
        if (searchDebounce) cancelAnimationFrame(searchDebounce);
        searchDebounce = requestAnimationFrame(() => {
            const list = fuzzySuggest(searchInput.value || '');
            showSuggestions(list);
        });
    });
    searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            const list = fuzzySuggest(searchInput.value || '');
            if (list[0]) {
                jumpToIdx(list[0].idx);
                hideSuggestions();
            }
        }
    });

    function jumpToIdx(idx) {
        const catItems = state[activeCat].items;
        if (!catItems[idx]) return;
        const page = Math.floor(idx / PAGE_SIZE) + 1;
        state[activeCat].page = page;
        pendingFocusId = `${activeCat}-${idx}`;
        render();
    }

    function focusCard(id) {
        const el = document.getElementById(id);
        if (!el) return;
        dimOverlay.classList.add('show');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
            dimOverlay.classList.remove('show');
        }, 2000);
    }

    function initializeTheme() {
        const stored = localStorage.getItem('theme');
        if (stored === 'light' || stored === 'dark') {
            applyTheme(stored);
            return;
        }
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
    }

    function applyTheme(theme) {
        const isLight = theme !== 'dark';
        document.body.dataset.theme = theme;
        document.documentElement.dataset.theme = theme;
        themeSwitch.classList.toggle('on', isLight);
        themeSwitch.setAttribute('aria-checked', String(isLight));
        localStorage.setItem('theme', theme);
    }

    const filterState = {
        watchYears: new Set(),
        // releaseYears: new Set(),  å·²ç§»é™¤
        ratings: new Set()
    };

    function getYearFromDate(val) {
        if (!val) return null;
        const d = new Date(val);
        return Number.isFinite(d.getTime()) ? d.getFullYear() : null;
    }

    function populateFilterOptions() {
        const items = state[activeCat].items || [];
        const watchYears = new Set();
        // const releaseYears = new Set(); å·²ç§»é™¤
        items.forEach(item => {
            const watch = getYearFromDate(item.updated_at || item.date);
            if (watch) watchYears.add(watch);
            // ä¸Šæ˜ å¹´ä»½æ”¶é›†å·²ç§»é™¤
        });
        renderChipList(watchYearWrap, [...watchYears].sort((a,b)=>b-a), filterState.watchYears);
        // ä¸å†æ¸²æŸ“ release å¹´ä»½
        if (!ratingWrap.dataset.ready) {
            const stars = [5,4,3,2,1];
            ratingWrap.innerHTML = stars.map(r => `
                <button type="button" class="chip" data-value="${r}">
                    ${'â­'.repeat(r)}
                </button>`).join('');
            ratingWrap.dataset.ready = '1';
            bindChipContainer(ratingWrap, filterState.ratings);
        } else {
            syncChipState(ratingWrap, filterState.ratings);
        }
    }

    function renderChipList(container, values, stateSet) {
        container.innerHTML = values.map(val => `
            <button type="button" class="chip ${stateSet.has(String(val))?'active':''}" data-value="${val}">
                ${val}
            </button>`).join('');
        bindChipContainer(container, stateSet);
    }

    function bindChipContainer(container, stateSet) {
        container.querySelectorAll('.chip').forEach(btn => {
            btn.onclick = () => {
                const value = btn.dataset.value;
                if (stateSet.has(value)) stateSet.delete(value);
                else stateSet.add(value);
                btn.classList.toggle('active');
                state[activeCat].page = 1;
                render();
            };
        });
    }

    function syncChipState(container, stateSet) {
        container.querySelectorAll('.chip').forEach(btn => {
            btn.classList.toggle('active', stateSet.has(btn.dataset.value));
        });
    }

    function applyIndexFilters(items) {
        // è¿”å› entriesï¼ˆåŒ…å«åŸå§‹ idxï¼‰ï¼Œä¾¿äºæ¸²æŸ“åç‚¹å‡»è¿˜åŸåˆ°åŸæ•°ç»„ç´¢å¼•
        const entries = (items || []).map((item, idx) => ({ item, idx }));
        const watchYears = filterState.watchYears;
        const ratings = filterState.ratings;
        if (!watchYears.size && !ratings.size) return entries;

        return entries.filter(({ item }) => {
            const watch = getYearFromDate(item.updated_at || item.date);
            if (watchYears.size && (!watch || !watchYears.has(String(watch)))) return false;
            const rating = Number(item.rating);
            if (ratings.size) {
                const rounded = Math.max(1, Math.min(5, Math.round(rating)));
                if (!ratings.has(String(rounded))) return false;
            }
            return true;
        });
    }


    loadAll();

    // æ–°å¢ï¼šåˆ·æ–°æŒ‰é’®ç»‘å®šï¼ˆå°è¯•åœ¨æµè§ˆå™¨ç«¯ç›´æ¥è°ƒç”¨ fetch_douban.js.mainï¼Œå¤±è´¥æ—¶å›é€€åˆ° /api/fetch-dataï¼‰
    (function(){
        const refreshBtn = document.getElementById('refresh-data-btn');
        if (!refreshBtn) return;
        refreshBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            refreshBtn.disabled = true;
            const originalText = refreshBtn.textContent;
            refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
            try {
                // å°è¯•åŠ¨æ€ importï¼ˆå¯èƒ½åœ¨æµè§ˆå™¨ç«¯å›  Node API è€Œå¤±è´¥ï¼‰
                try {
                    const res = await fetch('/api/fresh', { method: 'GET' });
                    if (!res.ok) throw new Error('åç«¯æ¥å£è¿”å›é”™è¯¯');
                    console.info('åç«¯ /api/fetch-data åˆ·æ–°å®Œæˆã€‚');
                } catch (err) {
                    console.warn('æ— æ³•åœ¨æµè§ˆå™¨ç›´æ¥æ‰§è¡Œ fetch_douban.js.', err);
                    throw new Error('åˆ·æ–°å¤±è´¥æˆ–å·²æœ‰åˆ·æ–°è„šæœ¬åœ¨æ‰§è¡Œä¸­ï¼Œè¯·ç¨åé‡è¯•ã€‚è‹¥æŒç»­å¤±è´¥è¯·æ£€æŸ¥ipåœ°å€æ˜¯å¦å¯è®¿é—®è±†ç“£ç½‘ã€‚');
                }
            } catch (e) {
                console.error(e);
                alert('' + (e && e.message ? e.message : 'æœªçŸ¥é”™è¯¯'));
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = originalText;
                // é‡æ–°åŠ è½½æ•°æ®
                await loadAll();
            }
        });
    })();
</script>
</body>
</html>
