<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <title>Ë±ÜÁì£Â™í‰ΩìÂêåÊ≠•ÔºàÊú¨Âú∞ JSON / Êó†ÂÆòÊñπ APIÔºâ</title>
    <style>
        :root {
            --bg: radial-gradient(180% 140% at 20% 20%, #f1f4ff 0%, #e8ecfb 45%, #dfe4f5 100%);
            --panel: rgba(255,255,255,0.7);
            --card: rgba(255,255,255,0.82);
            --card-strong: rgba(245,245,255,0.9);
            --text: #0f172a;
            --muted: #5d6a86;
            --accent: #6bd9a4;
            --accent-2: #6a8dff;
            --accent-3: #ff9f76;
            --radius: 18px;
            --shadow: 0 16px 38px rgba(0,0,0,0.15);
            --blur: 12px;
            --gap: 22px;
        }
        [data-theme="dark"] {
            --bg: radial-gradient(180% 140% at 20% 20%, #1c2033 0%, #0f1324 45%, #090b14 100%);
            --panel: rgba(22, 27, 46, 0.8);
            --card: rgba(23, 28, 47, 0.9);
            --card-strong: rgba(34, 42, 72, 0.95);
            --text: #e9efff;
            --muted: #8fa0c3;
            --accent: #6de0ad;
            --accent-2: #6a8dff;
            --accent-3: #ff9f76;
            --shadow: 0 20px 50px rgba(0,0,0,0.45);
            --blur: 14px;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: "SF Pro Display","Inter","PingFang SC","Microsoft YaHei",sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; }
        .sidebar { width: 92px; padding: 22px 12px; display: flex; flex-direction: column; align-items: center; gap: 18px; background: var(--panel); border-right: 1px solid rgba(255,255,255,0.08); box-shadow: var(--shadow); backdrop-filter: blur(var(--blur)); }
        .nav { display: flex; flex-direction: column; gap: 12px; width: 100%; margin-top: 12px; }
        .nav button { width: 100%; aspect-ratio: 1/1; border: none; border-radius: 16px; background: var(--card); color: var(--text); font-size: 18px; cursor: pointer; box-shadow: var(--shadow); backdrop-filter: blur(var(--blur)); transition: transform .1s ease, background .2s ease, box-shadow .2s ease; }
        .nav button.active { background: linear-gradient(135deg,var(--accent-2),var(--accent)); color: #fff; transform: translateY(-1px); box-shadow: 0 12px 30px rgba(90,140,255,0.35); }
        .spacer { flex: 1; }
        .gear { width: 48px; height: 48px; border-radius: 16px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.1); background: var(--card-strong); color: var(--text); display: grid; place-items: center; cursor: pointer; }

        .main { flex: 1; padding: 20px 30px 32px; display: flex; flex-direction: column; gap: 16px; backdrop-filter: blur(4px); }
        header { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; justify-content: center; }
        .search-box { position: relative; min-width: 540px; } /* ÊîæÂ§ß50% */
        #search-input { width: 100%; border: none; outline: none; background: var(--card); color: var(--text); padding: 14px 56px 14px 18px; border-radius: 14px; box-shadow: var(--shadow); font-size: 14px; backdrop-filter: blur(var(--blur)); }
        .search-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--muted); pointer-events: none; }
        .suggestions { position: absolute; top: 108%; left: 0; right: 0; background: var(--card-strong); border-radius: 14px; box-shadow: var(--shadow); max-height: 300px; overflow-y: auto; z-index: 10; display: none; backdrop-filter: blur(var(--blur)); }
        .suggestion-item { display: grid; grid-template-columns: 40px 1fr; align-items: center; gap: 10px; padding: 8px 10px; cursor: pointer; }
        .suggestion-item img { width: 40px; height: 54px; object-fit: cover; border-radius: 10px; background: rgba(0,0,0,0.06); }
        .suggestion-item .title { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .suggestion-item:hover { background: rgba(90,140,255,0.12); }

        .summary, .overview { display: none !important; }

        .section-head { display: flex; align-items: center; justify-content: space-between; color: var(--muted); }
        .pill { padding: 8px 12px; border-radius: 12px; background: var(--card); color: var(--muted); box-shadow: var(--shadow); backdrop-filter: blur(var(--blur)); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--gap); }
        .card { background: var(--card); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); display: flex; gap: 14px; align-items: flex-start; position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.06); min-height: 170px; cursor: pointer; backdrop-filter: blur(var(--blur)); z-index: 1; }
        .card::after { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at 30% 20%, rgba(90,140,255,0.12), transparent 55%); opacity: 0; pointer-events: none; transition: opacity .25s ease; }
        .card:hover::after { opacity: 1; }
        .card img { width: 92px; height: 128px; object-fit: cover; border-radius: 14px; flex-shrink: 0; background: rgba(255,255,255,0.18); border: 1px solid rgba(0,0,0,0.08); backdrop-filter: blur(var(--blur)); }
        .title-txt { font-weight: 800; font-size: 15px; line-height: 1.45; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .meta, .desc, .tags, .comment-brief { color: var(--muted); font-size: 13px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .desc { -webkit-line-clamp: 2; }
        .tags { color: #b8894d; font-size: 12px; }
        .time { color: #4ea785; font-size: 12px; margin-top: 4px; }
        .comment-brief { color: #c37b44; }
        .highlight { animation: flash 1.4s ease; box-shadow: 0 0 0 4px rgba(90,140,255,0.28), var(--shadow); border-color: rgba(90,140,255,0.35); }
        @keyframes focusPulse {
            0% { transform: scale(1); }
            40% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }
        .focus-anim { animation: focusPulse 2s ease; position: relative; z-index: 40; }
        @keyframes flash { 0% { transform: scale(1); } 50% { transform: scale(1.015); } 100% { transform: scale(1); } }

        .pagination { display: flex; gap: 10px; align-items: center; justify-content: flex-end; margin-top: 12px; flex-wrap: wrap; }
        .pagination button { border: none; border-radius: 12px; padding: 8px 12px; cursor: pointer; background: var(--card); box-shadow: var(--shadow); color: var(--text); backdrop-filter: blur(var(--blur)); }
        .info-card { padding: 10px 14px; border-radius: 12px; background: var(--card); box-shadow: var(--shadow); backdrop-filter: blur(var(--blur)); border: 1px solid rgba(0,0,0,0.08); color: var(--muted); }
        .page-jump { display: inline-flex; align-items: center; gap: 6px; }
        .page-input { width: 80px; padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.12); background: var(--card); color: var(--text); }

        .modal-backdrop, .detail-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 20; backdrop-filter: blur(6px); }
        .detail-backdrop { z-index: 25; }
        .modal, .detail-modal { background: var(--card-strong); color: var(--text); padding: 20px; border-radius: 18px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.08); backdrop-filter: blur(var(--blur)); }
        .modal { width: 360px; max-height: 80vh; overflow: auto; }
        .detail-modal { width: 540px; max-height: 80vh; overflow: auto; }
        .modal h3 { margin: 0 0 14px; }
        .modal-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .switch { position: relative; width: 46px; height: 26px; background: rgba(0,0,0,0.08); border-radius: 999px; cursor: pointer; }
        .switch::after { content: ""; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; border-radius: 50%; background: #fff; transition: transform .2s ease; }
        .switch.on { background: linear-gradient(135deg, var(--accent-2), var(--accent)); }
        .switch.on::after { transform: translateX(20px); }
        .modal-actions { text-align: right; margin-top: 6px; }
        .modal button { padding: 8px 14px; border-radius: 12px; border: none; background: var(--card); box-shadow: var(--shadow); cursor: pointer; }

        .comment-item { margin-bottom: 8px; padding: 10px; border-radius: 12px; background: rgba(0,0,0,0.05); }
        [data-theme="dark"] .comment-item { background: rgba(255,255,255,0.12); }

        .detail-body { display: flex; gap: 14px; align-items: flex-start; }
        .detail-cover { width: 120px; height: 168px; border-radius: 14px; object-fit: cover; background: rgba(255,255,255,0.1); border: 1px solid rgba(0,0,0,0.08); }
        .detail-section { margin-top: 12px; }
        .detail-section b { display: block; margin-bottom: 4px; }

        .dim-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.3);
            pointer-events: none; opacity: 0; transition: opacity .2s ease;
            z-index: 30;
        }
        .dim-overlay.show { opacity: 1; }
    </style>
</head>
<body data-theme="light">
<aside class="sidebar">
    <div class="nav">
        <button data-cat="movies" class="active" title="ÁîµÂΩ±">üé¨</button>
        <button data-cat="books"  title="‰π¶Á±ç">üìö</button>
        <button data-cat="games"  title="Ê∏∏Êàè">üéÆ</button>
        <button data-cat="music"  title="Èü≥‰πê">üéµ</button>
    </div>
    <div class="spacer"></div>
    <div class="gear" id="settings-btn">‚öôÔ∏è</div>
</aside>

<main class="main">
    <header>
        <div class="search-box">
            <input id="search-input" type="text" placeholder="ÊêúÁ¥¢..." aria-label="ÊêúÁ¥¢" />
            <span class="search-icon">üîç</span>
            <div id="suggestions" class="suggestions"></div>
        </div>
    </header>

    <div class="section-head">
        <div class="pill">ÂΩìÂâçÁ±ªÂà´Ôºö<span id="current-cat">ÁîµÂΩ±</span></div>
    </div>

    <div id="content" class="grid"></div>
    <div class="pagination">
        <button id="prev-page">‚Äπ ‰∏ä‰∏ÄÈ°µ</button>
        <div class="info-card" id="page-info-bottom">Á¨¨ 1 / 1 È°µ</div>
        <div class="page-jump">
            <label for="page-input" style="color:var(--muted);font-size:13px;">Ë∑≥ËΩ¨È°µ</label>
            <input id="page-input" class="page-input" type="number" min="1" step="1" />
        </div>
        <button id="next-page">‰∏ã‰∏ÄÈ°µ ‚Ä∫</button>
    </div>
</main>

<div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
        <h3>ËÆæÁΩÆ</h3>
        <div class="modal-row">
            <span>ÊµÖËâ≤Ê®°Âºè</span>
            <div id="theme-switch" class="switch on"></div>
        </div>
        <div class="modal-actions">
            <button id="close-modal">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<div class="detail-backdrop" id="detail-backdrop">
    <div class="detail-modal">
        <button id="detail-close" style="float:right;">‚úï</button>
        <div class="detail-body">
            <img id="detail-cover" class="detail-cover" alt="cover" src="" />
            <div>
                <h3 id="detail-title"></h3>
                <div id="detail-meta" class="meta"></div>
            </div>
        </div>
        <div class="detail-section">
            <b>ÁÆÄ‰ªã</b>
            <div id="detail-desc" class="meta"></div>
        </div>
        <div class="detail-section">
            <b>Ê†áÁ≠æ</b>
            <div id="detail-tags" class="tags"></div>
        </div>
        <div class="detail-section">
            <b>Êó∂Èó¥</b>
            <div id="detail-time" class="time"></div>
        </div>
        <div class="detail-section">
            <b>ËØÑËÆ∫</b>
            <div id="detail-comments" class="detail-comments"></div>
        </div>
    </div>
</div>

<div class="dim-overlay" id="dim-overlay"></div>

<script>
    document.body.dataset.theme = 'light';
    document.getElementById('theme-switch').classList.add('on');

    const searchInput = document.getElementById('search-input');
    const suggestionsBox = document.getElementById('suggestions');
    const contentEl = document.getElementById('content');
    const currentCatLabel = document.getElementById('current-cat');
    const settingsBtn = document.getElementById('settings-btn');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const closeModalBtn = document.getElementById('close-modal');
    const themeSwitch = document.getElementById('theme-switch');
    const detailBackdrop = document.getElementById('detail-backdrop');
    const detailClose = document.getElementById('detail-close');
    const detailTitle = document.getElementById('detail-title');
    const detailMeta = document.getElementById('detail-meta');
    const detailDesc = document.getElementById('detail-desc');
    const detailTags = document.getElementById('detail-tags');
    const detailTime = document.getElementById('detail-time');
    const detailComments = document.getElementById('detail-comments');
    const detailCover = document.getElementById('detail-cover');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const pageInfoBottom = document.getElementById('page-info-bottom');
    const pageInput = document.getElementById('page-input');
    const dimOverlay = document.getElementById('dim-overlay');

    const PAGE_SIZE = 24;
    const BATCH_SIZE = 24;
    const state = {
        movies: { items: [], page: 1 },
        books:  { items: [], page: 1 },
        games:  { items: [], page: 1 },
        music:  { items: [], page: 1 },
    };
    let activeCat = 'movies';
    let pendingFocusId = null;
    const globalIndex = { movies: [], books: [], games: [], music: [] };

    const ENDPOINTS = {
        movies: '/data/movies.json',
        books:  '/data/books.json',
        games:  '/data/games.json',
        music:  '/data/music.json',
    };

    document.querySelectorAll('.nav button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeCat = btn.dataset.cat;
            state[activeCat].page = 1;
            currentCatLabel.textContent = {movies:'ÁîµÂΩ±',books:'‰π¶Á±ç',games:'Ê∏∏Êàè',music:'Èü≥‰πê'}[activeCat];
            render();
        });
    });

    settingsBtn.onclick = () => { modalBackdrop.style.display = 'flex'; };
    closeModalBtn.onclick = () => { modalBackdrop.style.display = 'none'; };
    themeSwitch.onclick = () => {
        themeSwitch.classList.toggle('on');
        const light = themeSwitch.classList.contains('on');
        document.body.dataset.theme = light ? 'light' : 'dark';
    };

    prevBtn.onclick = () => changePage(-1);
    nextBtn.onclick = () => changePage(1);

    pageInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            const target = Number(pageInput.value);
            const totalPages = Math.max(1, Math.ceil(state[activeCat].items.length / PAGE_SIZE));
            const page = Math.min(totalPages, Math.max(1, isFinite(target) ? target : 1));
            state[activeCat].page = page;
            render();
        }
    });

    function changePage(delta) {
        const catState = state[activeCat];
        const total = Math.max(1, Math.ceil(catState.items.length / PAGE_SIZE));
        catState.page = Math.min(total, Math.max(1, catState.page + delta));
        render();
    }

    function starify(rating) {
        if (!rating) return '';
        const n = Math.max(1, Math.min(5, Number(rating)));
        return 'üåü'.repeat(n);
    }

    function openDetail(item) {
        detailTitle.textContent = item.title || item.name || 'Êú™ÂëΩÂêç';
        const year = item.year || '';
        const stars = starify(item.rating);
        detailMeta.textContent = [year, stars].filter(Boolean).join(' ¬∑ ');
        detailDesc.textContent = item.desc || item.summary || '';
        detailTags.textContent = item.tags && item.tags.length ? `#${item.tags.join(' #')}` : '';
        detailTime.textContent = item.updated_at || item.date || '';
        const comments = item.comments || [];
        detailComments.innerHTML = comments.length
            ? comments.map(c => `<div class="comment-item">${c}</div>`).join('')
            : '<div class="comment-item">ÊöÇÊó†ËØÑËÆ∫</div>';
        const cover = item.cover || item.image || '';
        if (cover) {
            detailCover.src = cover;
            detailCover.setAttribute('referrerpolicy', 'no-referrer');
            detailCover.onerror = () => { detailCover.src = `data:image/svg+xml,${encodeURIComponent(placeholderSvg(item.title))}`; };
        } else {
            detailCover.src = `data:image/svg+xml,${encodeURIComponent(placeholderSvg(item.title))}`;
        }
        detailBackdrop.style.display = 'flex';
    }
    detailBackdrop.addEventListener('click', e => { if (e.target === detailBackdrop) detailBackdrop.style.display = 'none'; });
    detailClose.onclick = () => detailBackdrop.style.display = 'none';

    async function loadAll() {
        await Promise.all(Object.keys(ENDPOINTS).map(loadCategory));
        render();
    }

    async function loadCategory(cat) {
        try {
            const res = await fetch(ENDPOINTS[cat], { cache: 'no-cache' });
            if (!res.ok) throw new Error('Ëé∑ÂèñÂ§±Ë¥•');
            const data = await res.json();
            state[cat].items = data.items || [];
            state[cat].page = 1;
            buildGlobalIndex(cat);
        } catch (e) {
            console.error(`${cat} Âä†ËΩΩÂ§±Ë¥•Ôºö${e.message}`);
        }
    }

    function buildGlobalIndex(cat) {
        globalIndex[cat] = (state[cat].items || []).map((item, idx) => ({
            titleLower: (item.title || item.name || '').toLowerCase(),
            title: item.title || item.name || 'Êú™ÂëΩÂêç',
            idx,
            cover: item.cover || item.image || '',
        }));
    }

    function render() {
        const { items, page } = state[activeCat];
        const totalPages = Math.max(1, Math.ceil(items.length / PAGE_SIZE));
        const start = (page - 1) * PAGE_SIZE;
        const pageItems = items.slice(start, start + PAGE_SIZE);

        contentEl.innerHTML = '';
        renderPageBatched(pageItems, start);

        pageInfoBottom.textContent = `Á¨¨ ${page} / ${totalPages} È°µ`;
        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page >= totalPages;
    }

    function renderPageBatched(list, offset) {
        let i = 0;
        function step() {
            const batchFrag = document.createDocumentFragment();
            for (let c = 0; c < BATCH_SIZE && i < list.length; c++, i++) {
                batchFrag.appendChild(makeCard(list[i], offset + i));
            }
            contentEl.appendChild(batchFrag);
            if (i < list.length) {
                requestAnimationFrame(step);
            } else {
                attachCardClicks();
                setupLazyImages();
                if (pendingFocusId) {
                    focusCard(pendingFocusId);
                    pendingFocusId = null;
                }
            }
        }
        step();
    }

    function makeCard(item, idx) {
        const cat = activeCat;
        const title = item.title || item.name || 'Êú™ÂëΩÂêç';
        const desc = item.desc || item.summary || '';
        const tags = item.tags && item.tags.length ? `#${item.tags.join(' #')}` : '';
        const stars = starify(item.rating);
        const year = item.year || '';
        const time = item.updated_at || item.date || '';
        const commentBrief = (item.comments && item.comments.length) ? item.comments[0] : '';
        const id = `${cat}-${idx}`;
        const slug = slugify(title || `pic-${id}`);
        const cover = item.cover || item.image || '';

        const card = document.createElement('div');
        card.className = 'card';
        card.id = id;
        card.dataset.cat = cat;
        card.dataset.idx = idx;

        const img = document.createElement('img');
        img.setAttribute('loading', 'lazy');
        img.dataset.cover = cover;
        img.dataset.slug = slug;
        img.alt = title;
        img.src = `data:image/svg+xml,${encodeURIComponent(placeholderSvg(title))}`;

        const info = document.createElement('div');
        info.innerHTML = `
        <div class="title-txt">${title}</div>
        <div class="meta">${[year, stars].filter(Boolean).join(' ¬∑ ')}</div>
        <div class="desc">${desc}</div>
        <div class="tags">${tags}</div>
        <div class="time">${time}</div>
        <div class="comment-brief">${commentBrief ? `üí¨ ${commentBrief}` : ''}</div>
      `;

        card.appendChild(img);
        card.appendChild(info);
        return card;
        }

    function attachCardClicks() {
      contentEl.querySelectorAll('.card').forEach(card => {
        card.onclick = () => {
          const cat = card.dataset.cat;
          const idx = Number(card.dataset.idx);
          const item = state[cat].items[idx];
          if (!item) return;
          openDetail(item);
        };
      });
    }

    const PIC_ROOT = '/data/pic';
    const slugHeadCache = new Set();
    let imgObserver = null;

    function setupLazyImages() {
      if (imgObserver) imgObserver.disconnect();
      imgObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            hydrateOneImage(entry.target);
            imgObserver.unobserve(entry.target);
          }
        });
      }, { rootMargin: '200px 0px', threshold: 0.1 });

      contentEl.querySelectorAll('img[data-cover][data-slug]').forEach(img => {
        imgObserver.observe(img);
      });
    }

    async function hydrateOneImage(img) {
      if (img.dataset.hydrated) return;
      const cover = img.dataset.cover;
      const slug = img.dataset.slug || 'pic';
      const localPath = `${PIC_ROOT}/${slug}.jpg`;

        if (slugHeadCache.has(localPath) || await headLocal(localPath)) {
            slugHeadCache.add(localPath);
            img.src = localPath;
            img.dataset.hydrated = '1';
            return;
        }
        if (!cover) return;
        const ok = await cacheRemote(slug, cover);
        if (ok) {
            slugHeadCache.add(localPath);
            img.src = localPath;
        } else {
            img.src = cover;
            img.onerror = () => { img.src = `data:image/svg+xml,${encodeURIComponent(placeholderSvg(cover))}`; };
        }
        img.dataset.hydrated = '1';
    }

    async function headLocal(path) { try { const res = await fetch(path, { method:'HEAD', cache:'no-cache' }); return res.ok; } catch { return false; } }
    async function cacheRemote(slug, coverUrl) {
        try {
            const res = await fetch('/api/cache-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slug, url: coverUrl }) });
            return res.ok;
        } catch { return false; }
    }
    function slugify(str) { return (str || 'pic').toLowerCase().replace(/[^\w\u4e00-\u9fa5]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'').slice(0,60) || 'pic'; }
    function placeholderSvg(text) {
        const safe = (text || '?').slice(0, 6);
        return `<svg xmlns='http://www.w3.org/2000/svg' width='160' height='220'>
        <rect width='100%' height='100%' fill='%23dfe4f5'/>
        <text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' fill='%235d6a86' font-size='18' font-family='Inter, sans-serif'>${safe}</text>
      </svg>`;
    }

    let searchDebounce = null;
    function fuzzySuggest(keyword) {
        const k = keyword.trim().toLowerCase();
        if (!k) return [];
        return globalIndex[activeCat].filter(x => x.titleLower.includes(k)).slice(0, 8);
    }

    function showSuggestions(list) {
        if (!list.length) { suggestionsBox.style.display = 'none'; suggestionsBox.innerHTML = ''; return; }
        suggestionsBox.innerHTML = list.map(x => `
        <div class="suggestion-item" data-idx="${x.idx}">
          <img src="${x.cover || `data:image/svg+xml,${encodeURIComponent(placeholderSvg(x.title))}`}" alt="">
          <div class="title">${x.title}</div>
        </div>
      `).join('');
        suggestionsBox.style.display = 'block';
    }
    function hideSuggestions() { suggestionsBox.style.display = 'none'; suggestionsBox.innerHTML = ''; }

    suggestionsBox.addEventListener('click', e => {
        const target = e.target.closest('.suggestion-item');
        if (!target) return;
        const idx = Number(target.dataset.idx);
        jumpToIdx(idx);
        hideSuggestions();
    });
    searchInput.addEventListener('input', () => {
        if (searchDebounce) cancelAnimationFrame(searchDebounce);
        searchDebounce = requestAnimationFrame(() => {
            const list = fuzzySuggest(searchInput.value || '');
            showSuggestions(list);
        });
    });
    searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            const list = fuzzySuggest(searchInput.value || '');
            if (list[0]) {
                jumpToIdx(list[0].idx);
                hideSuggestions();
            }
        }
    });

    function jumpToIdx(idx) {
        const catItems = state[activeCat].items;
        if (!catItems[idx]) return;
        const page = Math.floor(idx / PAGE_SIZE) + 1;
        state[activeCat].page = page;
        pendingFocusId = `${activeCat}-${idx}`;
        render();
    }

    function focusCard(id) {
        const el = document.getElementById(id);
        if (!el) return;
        dimOverlay.classList.add('show');
        el.classList.remove('focus-anim');
        void el.offsetWidth;
        el.classList.add('focus-anim');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
            el.classList.remove('focus-anim');
            dimOverlay.classList.remove('show');
        }, 2000);
    }

    loadAll();
</script>
</body>
</html>