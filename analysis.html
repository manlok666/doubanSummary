<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>è±†ç“£ç”µå½±æ•°æ®åˆ†æ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body data-page="analysis">
<a href="index.html" class="back">ğŸ‘ˆè¿”å›é¦–é¡µ</a>
<h1>è±†ç“£ç”µå½±æ•°æ®åˆ†æ</h1>

<!-- æ–°å¢ï¼šèŒƒå›´ç­›é€‰åŒºåŸŸ -->
<div class="filter-row">
    <label for="filter-start">æ›´æ–°æ—¶é—´ â‰¥</label>
    <input id="filter-start" type="date" />
    <label for="filter-end">æ›´æ–°æ—¶é—´ â‰¤</label>
    <input id="filter-end" type="date" />
</div>

<div class="summary" id="summary-cards"></div>

<section class="flex">
    <div class="list">
        <h3>çƒ­é—¨ç±»å‹ Top5</h3>
        <ul id="genre-list"></ul>
    </div>
    <div class="list">
        <h3>ä¸»è¦è¯­è¨€ Top5</h3>
        <ul id="language-list"></ul>
    </div>
    <div class="list">
        <h3>è¯„åˆ†åˆ†å¸ƒ</h3>
        <ul id="rating-list"></ul>
    </div>
    <div class="list">
        <h3>æ¼”å‘˜æ’è¡Œæ¦œ</h3>
        <ul id="actor-list"></ul>
    </div>
    <div class="list">
        <h3>å¯¼æ¼”æ’è¡Œæ¦œ</h3>
        <ul id="director-list"></ul>
    </div>
</section>

<section>
    <h2>å¹´ä»½ä¸ç‰‡é•¿æ¦‚è§ˆ</h2>
    <table>
        <thead>
        <tr>
            <th>å¹´ä»½</th>
            <th>éƒ¨æ•°</th>
            <th>å¹³å‡ç‰‡é•¿(åˆ†é’Ÿ)</th>
        </tr>
        </thead>
        <tbody id="year-table"></tbody>
    </table>
</section>

<script>
    async function loadMovies() {
        const res = await fetch('/data/movies.json', { cache: 'no-cache' });
        if (!res.ok) throw new Error('æ— æ³•åŠ è½½ movies.json');
        const data = await res.json();
        return Array.isArray(data.items) ? data.items : [];
    }

    function average(arr) {
        return arr.length ? arr.reduce((sum, v) => sum + v, 0) / arr.length : 0;
    }

    function frequencyMap(items, extractor) {
        const map = new Map();
        items.forEach(item => {
            const values = extractor(item);
            values.filter(Boolean).forEach(val => {
                map.set(val, (map.get(val) || 0) + 1);
            });
        });
        return [...map.entries()].sort((a, b) => b[1] - a[1]);
    }

    const filterStart = document.getElementById('filter-start');
    const filterEnd = document.getElementById('filter-end');
    let allItems = [];

    function normalizeField(value) {
        if (!value) return [];
        if (Array.isArray(value)) return value.map(v => v.trim()).filter(Boolean);
        return value.toString().split(/[ï¼Œ,ã€\/]+/).map(v => v.trim()).filter(Boolean);
    }

    function getFilteredItems() {
        const start = filterStart.value ? new Date(filterStart.value) : null;
        const end = filterEnd.value ? new Date(filterEnd.value) : null;
        return allItems.filter(item => {
            if (!item.updated_at) return true;
            const date = new Date(item.updated_at);
            if (Number.isNaN(date)) return true;
            if (start && date < start) return false;
            if (end && date > end) return false;
            return true;
        });
    }

    function renderTopList(targetId, list, emptyLabel = 'æš‚æ— æ•°æ®') {
        const target = document.getElementById(targetId);
        target.innerHTML = list.slice(0, 5).map(([label, count]) =>
            `<li>${label}<span class="badge">${count}</span></li>`
        ).join('') || `<li>${emptyLabel}</li>`;
    }

    function populateSummary(items) {
            const ratings = items.map(x => Number(x.rating)).filter(Number.isFinite);
            const years = items.map(x => Number(x.release_year)).filter(Number.isFinite);
            const durations = items.map(x => Number(x.duration_minutes)).filter(Number.isFinite);
            const totalMinutes = durations.reduce((sum, v) => sum + v, 0);
            const totalCommentChars = items.reduce((sum, item) => {
                const comments = Array.isArray(item.comments) ? item.comments : [];
                return sum + comments.reduce((cSum, comment) => cSum + (comment ? comment.length : 0), 0);
            }, 0);

            const cards = [
                { label: 'å½±ç‰‡æ€»æ•°', value: items.length },
                { label: 'å¹³å‡è¯„åˆ†', value: ratings.length ? average(ratings).toFixed(2) : 'â€”' },
                { label: 'å¹´ä»½è·¨åº¦', value: years.length ? `${Math.min(...years)} - ${Math.max(...years)}` : 'â€”' },
                { label: 'å¹³å‡ç‰‡é•¿', value: durations.length ? `${Math.round(average(durations))} åˆ†é’Ÿ` : 'â€”' },
                { label: 'ç´¯è®¡è§‚çœ‹æ—¶é•¿', value: durations.length ? `${(totalMinutes / 60).toFixed(1)} å°æ—¶` : 'â€”' },
                { label: 'ç´¯è®¡è¯„è®ºå­—æ•°', value: totalCommentChars ? `${totalCommentChars.toLocaleString()} å­—` : 'â€”' },
            ];

            document.getElementById('summary-cards').innerHTML = cards.map(card => `
            <div class="card">
                <h2>${card.label}</h2>
                <p>${card.value}</p>
            </div>
        `).join('');
    }

    function populateLists(items) {
        const genres = frequencyMap(items, item => Array.isArray(item.genres) ? item.genres : (item.genres ? [item.genres] : []));
        const languages = frequencyMap(items, item => Array.isArray(item.languages) ? item.languages : (item.languages ? [item.languages] : []));
        const ratingsCount = frequencyMap(items, item => Number.isFinite(Number(item.rating)) ? [`${item.rating} æ˜Ÿ`] : []);

        renderTopList('genre-list', genres);
        renderTopList('language-list', languages);
        renderTopList('rating-list', ratingsCount);
    }

    function populateActorDirector(items) {
        const actors = frequencyMap(items, item => normalizeField(item.actors));
        const directors = frequencyMap(items, item => normalizeField(item.directors));
        renderTopList('actor-list', actors);
        renderTopList('director-list', directors);
    }

    function populateYearTable(items) {
        const yearMap = new Map();
        items.forEach(item => {
            const year = Number(item.release_year);
            const duration = Number(item.duration_minutes);
            if (!Number.isFinite(year)) return;
            if (!yearMap.has(year)) yearMap.set(year, []);
            if (Number.isFinite(duration)) yearMap.get(year).push(duration);
        });

        const rows = [...yearMap.entries()].sort((a, b) => a[0] - b[0]).map(([year, durations]) => `
        <tr>
            <td>${year}</td>
            <td>${durations.length}</td>
            <td>${durations.length ? Math.round(average(durations)) : 'â€”'}</td>
        </tr>
    `).join('') || '<tr><td colspan="3">æš‚æ— å¹´ä»½æ•°æ®</td></tr>';

        document.getElementById('year-table').innerHTML = rows;
    }

    function refreshDashboard() {
        const filtered = getFilteredItems();
        populateSummary(filtered);
        populateLists(filtered);
        populateActorDirector(filtered);
        populateYearTable(filtered);
    }

    filterStart.addEventListener('change', refreshDashboard);
    filterEnd.addEventListener('change', refreshDashboard);

    (async function init() {
        try {
            const items = await loadMovies();
            allItems = items;
            populateLists(items);
            populateYearTable(items);
            populateActorDirector(items);
            populateSummary(items);
            // åˆå§‹ç­›é€‰åå†æ¸²æŸ“ä¸€æ¬¡ï¼Œç¡®ä¿é»˜è®¤çŠ¶æ€ä¸€è‡´
            refreshDashboard();
        } catch (err) {
            document.body.innerHTML = `<p style="color:#dc2626;">åŠ è½½å¤±è´¥ï¼š${err.message}</p>`;
        }
    })();
</script>
</body>
</html>
